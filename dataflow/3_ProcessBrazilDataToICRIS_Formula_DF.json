{
	"name": "3_ProcessBrazilDataToICRIS_Formula_DF",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "stgColor",
						"type": "DatasetReference"
					},
					"name": "stgColor"
				},
				{
					"dataset": {
						"referenceName": "ICRISstgFormula",
						"type": "DatasetReference"
					},
					"name": "ICRISstgFormula"
				},
				{
					"dataset": {
						"referenceName": "stgFormula",
						"type": "DatasetReference"
					},
					"name": "stgFormula"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ICRISstgFormula",
						"type": "DatasetReference"
					},
					"name": "InsertFormula"
				},
				{
					"dataset": {
						"referenceName": "ICRISstgFormula",
						"type": "DatasetReference"
					},
					"name": "UpdateFormula"
				},
				{
					"dataset": {
						"referenceName": "ICRISstgFormula",
						"type": "DatasetReference"
					},
					"name": "DeleteFormula"
				}
			],
			"transformations": [
				{
					"name": "JoinOnFormula"
				},
				{
					"name": "joinICRISFormula"
				},
				{
					"name": "select1"
				},
				{
					"name": "derivedColumn1"
				},
				{
					"name": "filter1"
				},
				{
					"name": "select2"
				},
				{
					"name": "select3"
				},
				{
					"name": "select4"
				},
				{
					"name": "derivedColumn2"
				},
				{
					"name": "select5"
				},
				{
					"name": "alterRow1"
				},
				{
					"name": "alterRow2"
				}
			],
			"scriptLines": [
				"source(output(",
				"          id as string,",
				"          originated as string,",
				"          universal_code as string,",
				"          color_name as string,",
				"          year as decimal(4,0),",
				"          version as decimal(4,0),",
				"          version_date as date,",
				"          brand as string,",
				"          effect as string,",
				"          density as decimal(8,4),",
				"          last_update as date",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> stgColor",
				"source(output(",
				"          Id as integer,",
				"          TalendId as integer,",
				"          ColorId as integer,",
				"          StagingId as string,",
				"          QualityId as string,",
				"          UndercoatCode as string,",
				"          Deleted as boolean,",
				"          DateCreated as timestamp,",
				"          DateModified as timestamp,",
				"          DateModifiedTalend as timestamp",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> ICRISstgFormula",
				"source(output(",
				"          id as decimal(8,0),",
				"          originated as string,",
				"          color as string,",
				"          line as string,",
				"          subline as string,",
				"          undercoat as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> stgFormula",
				"stgColor, stgFormula join(stgColor@id == color,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> JoinOnFormula",
				"select1, ICRISstgFormula join({id(INCLR)} == StagingId,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> joinICRISFormula",
				"JoinOnFormula select(mapColumn(",
				"          {id(INCLR)} = stgColor@id,",
				"          {originated(INCLR)} = stgColor@originated,",
				"          {universal_code(INCLR)} = universal_code,",
				"          {color_name(INCLR)} = color_name,",
				"          {year(INCLR)} = year,",
				"          {version(INCLR)} = version,",
				"          {version_date(INCLR)} = version_date,",
				"          {brand(INCLR)} = brand,",
				"          {effect(INCLR)} = effect,",
				"          {density(INCLR)} = density,",
				"          {last_update(INCLR)} = last_update,",
				"          {id(INFRM)} = stgFormula@id,",
				"          {originated(INFRM)} = stgFormula@originated,",
				"          {color(INFRM)} = color,",
				"          {line(INFRM)} = line,",
				"          {subline(INFRM)} = subline,",
				"          {undercoat(INFRM)} = undercoat",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select1",
				"select2 derive(newDate_Created1 = iif(equals(toString({version_date(INCLR)}), '0001-01-01'), toDate('1900-01-01'), {version_date(INCLR)}),",
				"          newDate_Modified1 = iif(equals(toString({version_date(INCLR)}), '0001-01-01'), toDate('1900-01-01'), {version_date(INCLR)}),",
				"          newId = '0',",
				"          newColorId = '0',",
				"          IfUndercoatIsNull = iif(isNull({undercoat(INFRM)}),'',{undercoat(INFRM)}),",
				"          NewDeleted = 'False') ~> derivedColumn1",
				"derivedColumn1 filter(isNull({StagingId(INICRISFRM)})) ~> filter1",
				"joinICRISFormula select(mapColumn(",
				"          {id(INCLR)},",
				"          {originated(INCLR)},",
				"          {universal_code(INCLR)},",
				"          {color_name(INCLR)},",
				"          {year(INCLR)},",
				"          {version(INCLR)},",
				"          {version_date(INCLR)},",
				"          {brand(INCLR)},",
				"          {effect(INCLR)},",
				"          {density(INCLR)},",
				"          {last_update(INCLR)},",
				"          {id(INFRM)},",
				"          {originated(INFRM)},",
				"          {color(INFRM)},",
				"          {line(INFRM)},",
				"          {subline(INFRM)},",
				"          {undercoat(INFRM)},",
				"          {Id(INICRISFRM)} = Id,",
				"          {TalendId(INICRISFRM)} = TalendId,",
				"          {ColorId(INICRISFRM)} = ColorId,",
				"          {StagingId(INICRISFRM)} = StagingId,",
				"          {QualityId(INICRISFRM)} = QualityId,",
				"          {UndercoatCode(INICRISFRM)} = UndercoatCode,",
				"          {Deleted(INICRISFRM)} = Deleted,",
				"          {DateCreated(INICRISFRM)} = DateCreated,",
				"          {DateModified(INICRISFRM)} = DateModified,",
				"          {DateModifiedTalend(INICRISFRM)} = DateModifiedTalend",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select2",
				"filter1 select(mapColumn(",
				"          Id = newId,",
				"          ColorId = newColorId,",
				"          StagingId = {color(INFRM)},",
				"          QualityId = {line(INFRM)},",
				"          UndercoatCode = IfUndercoatIsNull,",
				"          Deleted = NewDeleted,",
				"          NewDate_Created1 = newDate_Created1,",
				"          NewDate_Modified1 = newDate_Modified1,",
				"          {DateModifiedTalend(INICRISFRM)} = {last_update(INCLR)}",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select3",
				"alterRow1 select(mapColumn(",
				"          TalendId = {TalendId(INICRISFRM)},",
				"          StagingId = {color_name(INCLR)},",
				"          QualityId = {line(INFRM)},",
				"          UndercoatCode = IfUndercoatIsNull,",
				"          Deleted = {Deleted(INICRISFRM)},",
				"          DateCreated = newDate_Created1,",
				"          DateModified = newDate_Modified1,",
				"          DateModifiedTalend = {last_update(INCLR)}",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select4",
				"alterRow2 derive(TrueDel = '1',",
				"          DelModifiedTalend = currentDate('{DateModifiedTalend(INICRISFRM)}')) ~> derivedColumn2",
				"derivedColumn2 select(mapColumn(",
				"          TalendId = {TalendId(INICRISFRM)},",
				"          Deleted = TrueDel,",
				"          DateModifiedTalend = DelModifiedTalend",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select5",
				"derivedColumn1 alterRow(updateIf(!isNull({StagingId(INICRISFRM)}))) ~> alterRow1",
				"select2 alterRow(deleteIf(isNull({id(INCLR)}))) ~> alterRow2",
				"select3 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          Id as integer,",
				"          TalendId as integer,",
				"          ColorId as integer,",
				"          StagingId as string,",
				"          QualityId as string,",
				"          UndercoatCode as string,",
				"          Deleted as boolean,",
				"          DateCreated as timestamp,",
				"          DateModified as timestamp,",
				"          DateModifiedTalend as timestamp",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     saveOrder: 1,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          Id,",
				"          ColorId,",
				"          StagingId,",
				"          QualityId,",
				"          UndercoatCode,",
				"          Deleted,",
				"          DateCreated = NewDate_Created1,",
				"          DateModified = NewDate_Modified1,",
				"          DateModifiedTalend = {DateModifiedTalend(INICRISFRM)}",
				"     )) ~> InsertFormula",
				"select4 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          Id as integer,",
				"          TalendId as integer,",
				"          ColorId as integer,",
				"          StagingId as string,",
				"          QualityId as string,",
				"          UndercoatCode as string,",
				"          Deleted as boolean,",
				"          DateCreated as timestamp,",
				"          DateModified as timestamp,",
				"          DateModifiedTalend as timestamp",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     saveOrder: 2,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          TalendId,",
				"          StagingId,",
				"          QualityId,",
				"          UndercoatCode,",
				"          Deleted,",
				"          DateCreated,",
				"          DateModified,",
				"          DateModifiedTalend",
				"     )) ~> UpdateFormula",
				"select5 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          Id as integer,",
				"          TalendId as integer,",
				"          ColorId as integer,",
				"          StagingId as string,",
				"          QualityId as string,",
				"          UndercoatCode as string,",
				"          Deleted as boolean,",
				"          DateCreated as timestamp,",
				"          DateModified as timestamp,",
				"          DateModifiedTalend as timestamp",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     saveOrder: 3,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          TalendId,",
				"          Deleted,",
				"          DateModifiedTalend",
				"     )) ~> DeleteFormula"
			]
		}
	}
}